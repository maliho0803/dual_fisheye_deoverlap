# dual_fisheye_deoverlap
about single fisheye camera calibration, dual camera calibration.

this repo is mainly about de-overlap the same object that appear in both fisheye camera

1、鱼眼图像矫正
	采用张正友相机标定方法，获取鱼眼摄像头的内参和畸变系数。*调整鱼眼摄像头和棋盘格的相对位置进行拍照获取8幅以上照片，多多益善。拍摄角度尽可能多样，图像做到遍历整个图像画面，如下图所示。


	Xc为相机坐标系，，，为相机坐标系中的任意一点P。，，，为相机的内参。由可求得相机坐标：

	获取入射角：
；；

	鱼眼多项式畸变模型：

	根据等距投影模型，投影点到图像中心的距离为(假设)：

	畸变矫正后图像坐标，假设P点在成像平面的投影与图像坐标x轴的夹角为：


	最终转换到像素坐标为：


2、双目鱼眼立体校正
	想要知道视差，首先应该知道双目视觉系统中两个摄像头之间的相对位置关系。我们可以通过同时对两个摄像头进行标定，分别得到二者相对同一坐标系的旋转矩阵和平移矩阵。获得这两个矩阵的过程，就是立体标定的过程。计算目标点在左右两个视图上形成的视差，首先要把该点在左右视图上两个对应的像点匹配起来。然而，在二维空间上匹配对应点是非常耗时的，为了减少匹配搜索范围，利用极线约束使得对应点的匹配由二维搜索降为一维搜索。

立体校正分两步走：
a)双目立体标定，获取旋转、平移矩阵
	双目立体标定采用张正友棋盘格标定法同时对两个鱼眼摄像头进行标定，与单目标定类似，除了获取内参以外，增加两个摄像头空间位置关系的标定。用旋转矩阵R和平移矩阵T来描述左右两个摄像机坐标系的相对关系，具体为将左摄像机下的坐标转换到右摄像机下的坐标。假设空间中有一点P，其在世界坐标系下的坐标为PW，其在左、右摄像机坐标系下的坐标可以表示为：


	其中和有以下关系：

	综上，推导出：


	其中，R为两摄像头间的旋转矩阵，T为两摄像头间的平移矩阵。为右摄像头经过张氏标定得到的相对标定物的旋转矩阵，为右摄像头通过张氏标定得到的相对标定物的平移向量。为左摄像头经过张氏标定得到的相对相同标定物的旋转矩阵，为左摄像头经过张氏标定得到的相对相同标定物的平移向量。R和T即为立体标定参数。
b)Bouguet极线对齐
	校正前的左右相机的光心并不平行，两个光心的连线就叫做基线，像平面与基线的交点就是极点，像点和极点所在的直线就是极线，左右极线与基线构成的平面就是空间点对应的极平面。矫正后，极点在无穷远处，两个相机的光轴平行。像点在左右图像上的高度一致。这也就是极线校正的目标。

	Bouguet方法根据立体标定求得的旋转和平移矩阵分解成左右相机各旋转一半的旋转和平移矩阵R1，R2与T1，T2。分解的原则是使得左右图像投影造成的畸变最小，左右视图的共面面积最大。该方法分为两步：
	共面：将相机旋转矩阵划分为左右相机的合成矩阵，，目的是实现图像成像面达到平行，但是行没有对齐。


		行对准：建立行对准旋转矩阵使极点转换到无穷远处。构造的方法是通过右相机相对于左相机的偏移矩阵T来完成。首先构造，变换矩阵将左视图的极点变换到无穷远，则使极线达到水平，可见左右相机投影中心之间的平移向量就是左极点方向：

		方向与主光轴方向正交，沿图像方向，与垂直，则知方向可通过与主光轴方向的叉积并归一化获得：

		获取了和后，与和正交，自然就是他们两个的叉积：

		最后可将左相机的极点转换到无穷远：

		根据合成旋转矩阵与变换矩阵、相乘获得左右相机的整体旋转矩阵。左右相机乘以各自的整体旋转矩阵就可使得左右相机的主光轴平行，且像平面与基线平行：


3、深度计算
1.立体匹配	
	完成极线对齐后就可以进行双目视差计算，如下图所示，P为空间中一点，其坐标为，，。P1和P2为P在左右视图中的成像点。获取视差的关键是对左右视图进行匹配，也就是对左视图中的P1点进行匹配获取右图中的对应点P2。本文中采用半全局立体匹配（SGBM）进行视差计算。

2.深度计算	
如上图所示，根据相似三角形原理有：

化简得：

其中为视差d，L为图像的宽度，f为焦距。
4、图像去重
a)物体检测模块分别对左、右图中进行检测，获得检测框位置和类别信息。
b)以左图为基（与计算视差时基准保持一致），针对左图中待检测区域内的检测结果进行遍历，计算每个检测框区域内的平均视差；
c)根据左图中检测框中心位置，以及平均视差，获取该物体在右图中的位置
将计算得到的物体位置与检测模块给出的检测结果进行对比，如果二者的中心位置差别在阈值范围以内，则认为是重复检测物体，否则不是。
